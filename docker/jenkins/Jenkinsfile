pipeline {
    // ìµœìƒë‹¨ agent anyëŠ” ìœ ì§€í•˜ë˜, Docker ëª…ë ¹ì´ í•„ìš”í•œ ìŠ¤í…Œì´ì§€ëŠ” ë³„ë„ agentë¥¼ ì‚¬ìš©
    agent any

    environment {
        DOCKER_IMAGE = "diamini/private_cloud_app"
        REGISTRY_CREDENTIAL = "dockerhub-token"    // Secret text í˜•íƒœë¡œ DockerHub token ë“±ë¡
        SONAR_HOST_URL = "http://192.168.119.135:9001"
        SSH_CREDENTIAL_ID = "ssh-test2"            // Jenkinsì— ë“±ë¡í•œ SSH key credentials
        DEPLOY_SERVER = "192.168.119.136"          // ë°°í¬ ì„œë²„ IP
        DOCKER_NETWORK = "monitoring"              // docker-compose.ymlì— ì •ì˜ëœ ë„¤íŠ¸ì›Œí¬ ì´ë¦„
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/seung9526/private_cloud_ubuntu.git'
            }
        }

        stage('SonarQube Analysis') {
            // Docker CLIê°€ ì„¤ì¹˜ëœ ì—ì´ì „íŠ¸ ì‚¬ìš© (Docker-in-Docker ë°©ì‹)
            agent {
                docker {
                    image 'docker:latest' 
                    // í˜¸ìŠ¤íŠ¸ì˜ Docker ì†Œì¼“ê³¼ ë„¤íŠ¸ì›Œí¬ë¥¼ ë§ˆìš´íŠ¸í•˜ì—¬ Docker ëª…ë ¹ì„ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•¨
                    args "-v /var/run/docker.sock:/var/run/docker.sock --network ${DOCKER_NETWORK}"
                }
            }
            steps {
                withCredentials([string(credentialsId: 'tonarqube-token', variable: 'SONAR_TOKEN')]) {
                    sh """
                        echo "Starting SonarQube Analysis using Docker CLI..."
                        docker run --rm \\
                            --network host \\
                            -v \$(pwd):/usr/src \\
                            -w /usr/src \\
                            sonarsource/sonar-scanner-cli \\
                            -Dsonar.projectKey=private_cloud_ubuntu \\
                            -Dsonar.sources=. \\
                            -Dsonar.host.url=${SONAR_HOST_URL} \\
                            -Dsonar.login=${SONAR_TOKEN}
                    """
                }
            }
        }

        stage('Build Docker Image') {
            // Docker CLIê°€ ì„¤ì¹˜ëœ ì—ì´ì „íŠ¸ ì‚¬ìš©
            agent {
                docker {
                    image 'docker:latest'
                    args "-v /var/run/docker.sock:/var/run/docker.sock --network ${DOCKER_NETWORK}"
                }
            }
            steps {
                sh "docker build --network=${DOCKER_NETWORK} -t ${DOCKER_IMAGE}:latest ."
            }
        }

        stage('Push to DockerHub') {
            // Docker CLIê°€ ì„¤ì¹˜ëœ ì—ì´ì „íŠ¸ ì‚¬ìš©
            agent {
                docker {
                    image 'docker:latest'
                    args "-v /var/run/docker.sock:/var/run/docker.sock --network ${DOCKER_NETWORK}"
                }
            }
            steps {
                withCredentials([string(credentialsId: "${REGISTRY_CREDENTIAL}", variable: 'DOCKER_TOKEN')]) {
                    sh """
                        echo "ğŸ” Logging into DockerHub with token..."
                        echo "$DOCKER_TOKEN" | docker login -u "diamini" --password-stdin
                        echo "ğŸš€ Pushing image to DockerHub..."
                        docker push ${DOCKER_IMAGE}:latest
                        docker logout
                    """
                }
            }
        }

        stage('Deploy to Remote Server') {
            agent any // SSH ì ‘ì†ë§Œ í•˜ë¯€ë¡œ ë©”ì¸ ì—ì´ì „íŠ¸ ì‚¬ìš©
            steps {
                sshagent(credentials: ["${SSH_CREDENTIAL_ID}"]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no test2@${DEPLOY_SERVER} '
                            echo "ğŸ›  Stopping existing container..."
                            docker stop private_cloud_app || true
                            docker rm private_cloud_app || true
                            echo "ğŸ“¦ Pulling latest image..."
                            docker pull ${DOCKER_IMAGE}:latest
                            echo "ğŸš€ Running new container..."
                            docker run -d --name private_cloud_app -p 8080:8080 ${DOCKER_IMAGE}:latest
                        '
                    """
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'trivy-report.txt', allowEmptyArchive: true
        }
    }
}
